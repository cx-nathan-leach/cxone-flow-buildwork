\chapter{Scan Agents}\label{sec:scan-agents}

\section{Overview}

Scan Agents are used as a method of performing some pre-scan processing of code to be submitted
for scan.  It can be considered similar to scripting that executes prior to submitting a scan
if executing in a CI/CD pipeline but with a much smaller scope of capabilities.  This is not
intended to replace the use of a CI/CD pipeline, but can assist with performing some basic
pre-scan steps for scans orchestrated by webhook events.

Performing pre-scan steps with the Scan Agent is similar to the mechanism of a CI/CD runner
used with SCMs that support integration of CI/CD pipelines.  An agent is installed on
a an existing runner agent or a standalone system, given a tag name that is representative
of the tooling environment, and is configured to receive scan requests from \cxoneflow.
The tooling environment tag is then referenced in the \cxone project configuration by
adding a tag to one or more project settings.


\section{Scan Agent Deployment}

Figure \ref{fig:scan-agent-deployment-diagram} shows a deployment diagram for some typical
Scan Agent deployment types.  The top box shows the Scan Agent process running on the same
machine as the CI/CD runner.  This is often a better way to perform a deployment given the
runner will typically have the correct development tooling installed and properly maintained
over time.  The bottom box shows the Scan Agent deployed on the "Build Box" that would have
similar properties as the CI/CD runner but may use other methods to invoke builds.


\begin{figure}[ht]
  \includegraphics[width=\textwidth]{graphics/cxoneflow-diagrams-Scan Agent Diagram.png}
  \caption{Scan Agent Deployment Diagram}
  \label{fig:scan-agent-deployment-diagram}
\end{figure}


\subsection{Scan Agent Security Considerations}\label{sec:scan-agent-security-considerations}

Performing code builds, as is typically performed in a CI/CD pipeline, often includes
a bit of risk in that a build requires the execution of scripting.  There are often
controls in place to prevent anyone other than trusted authors from authoring the build scripts.
If those controls fail or are bypassed, the Scan Agent could be made to execute arbitrary
script commands which could include executing attacker-controlled code.

The use of Scan Agents involves some of the same risks as those that exist in
CI/CD pipeline builds.  The pre-scan scripting is controlled by the
administrator that is deploying the Scan Agent; this can help to limit the exposure
of arbitrary shell script execution.  Schemes where the script detects and executes
additional commands that are provided by code from the repository can create
a remote code execution attack vector.  If the use of the pre-scan scripting is designed
to execute commands found in the code under scan, use caution.

Executing \scaresolver can also represent a remote code execution attack vector when the package manager has
the capability for the package resolution to execute code.  A package manifest,
usually provided by code checked into the repository, that references a malicious package may also
open a remote code execution attack vector.  The scope of what can be accomplished by a malicious package
executing in the build system will depend on what the malicious package is allowed to execute and what data
it can exfiltrate from a system where it is executing.

The deployment details in the following sections will provide security recommendations
that, if followed, can minimize the impact if Scan Agents' execution
capabilities are somehow exploited.  Scenarios where \scaresolver and the pre-scan script are executed in
an instance of a container can limit the impact of any exploits but should not be expected
to completely avoid all potential impacts. 

The \cxoneflow endpoint server itself does not invoke any scripting or tools as part of the 
Scan Agent workflow; this action is delegated to the Scan Agents.  However, be aware that a required step of the
Scan Agent execution is to obtain a clone of the code for scanning.  To facilitate this,
the \cxoneflow endpoint server does send encoded SCM credentials to authorized
Scan Agents.  Section \ref{sec:scan-agent-security} has more details
about security considerations for Scan Agent installation.

The purpose of the \scaresolver scan is to detect vulnerable and malicious packages. It
should therefore be anticipated that malicious packages may be inadvertently referenced
by developers in the package manifest.  If the step to execute \scaresolver is enabled
and the package manifest references a malicious package, take all precautions that
would be suitable to assess anything that may have been modified by any actions the package
manager allowed the malicious package to execute.

The following security recommendations should be considered as part of deployment of \cxoneflow with Scan Agents:
\begin{itemize}
  \item Use SSL for all message queue connections.
  \item Use SSL connections for delivering SCM events to the \cxoneflow endpoints.
  \item Isolate the Scan Agent either through installing on isolated subnets or using OS permissions to
  isolate the Scan Agent runtime.
  \item Configure Scan Agents to execute build tools inside containers to isolate the \scaresolver and pre-scan execution from
  the Scan Agents' runtime.
  \item If a scan detects a malicious package, rotate all credentials used by \cxoneflow and Scan Agents
  after the reference to the malicious package is removed from the source code.\footnote{CAUTION: Opening the code that
  references a malicious package in an IDE may also execute the package's malicious payload!}
\end{itemize}

\input{resolver/server.tex}
\input{resolver/agent.tex}

